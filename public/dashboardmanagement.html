<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Latency Slayer</title>
  <script src="script/components/navBar.js"></script>
  <script src="script/components/kpi.js"></script>
  <link rel="stylesheet" href="style/dashboardManagement.css" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body onload="getRelatorioDeChamadosDoMesPassado(), atualizarChamados(), alertasPorServidor(), getChamadosSemReponsavel(), getResponsavelSemAtribuicao(), getChamadosTotais()">
  <nav-bar></nav-bar>

  <main>
    <div class="kpis">
      <div class="kpi">
        <div class="titulo-kpi">Chamados abertos sem responsável</div>
        <div class="kpi-infos">
          <div class="kpi-numeros" id="kpi-chamados-abertos-sem-atribuicao"></div>
          <div class="kpi-mensagem">Chamados em aberto sem responsável</div>
        </div>

        <div class="rodape">
          <div class="label">
            <div id="porcentagemKpiSemAtribuicao"></div> do total de chamados (total de <div id="kpi-chamados-abertos">
            </div>)
          </div>
        </div>
      </div>

      <div class="kpi">
        <div class="titulo-kpi">Quantidade de chamados do mês</div>
        <div class="kpi-infos">
          <div class="kpi-numeros" id="kpi-chamados-totais"></div>
          <div class="kpi-mensagem">chamados somente neste mês</div>
        </div>

        <div class="rodape">
          <div class="label">20% acima (mês passado: 18)</div>
        </div>
      </div>

      <div class="kpi">
        <div class="titulo-kpi">
          Top servidores com mais ocorrências (em 7 dias)
        </div>
        <div class="kpi-infos-col">
          <div class="label">
            <div id="sv_ocorrencias"></div> ocorrências em <div id="sv_tag_name"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="graficos">
      <div class="graficos-linha-1">
        <div class="first-grafico-linha-1">
          <div class="box-first-grafico-linha-1">
            <div class="titulo-first-grafico-linha-1">
              Relatório de chamados do mês
            </div>

            <div id="chart"></div>
          </div>
        </div>

        <div class="second-grafico-linha-1">
          <div class="box-second-grafico-linha-1">
            <div class="titulo-second-grafico-linha-1">
              Lista de chamados por servidor
            </div>

            <div class="lista-second-grafico-linha-1">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Chamado</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>

                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="graficos-linha-2">
        <div class="first-grafico-linha-2">
          <div class="box-first-grafico-linha-2">
            <div class="titulo-first-grafico-linha-2">
              Lista de chamados sem atribuição
            </div>

            <div class="lista-first-grafico-linha-2">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Relator</th>
                    <th>Status</th>
                    <th>Grupo</th>
                  </tr>
                </thead>

                <tbody>
                  
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="second-grafico-linha-2">
          <div class="box-second-grafico-linha-2">
            <div class="titulo-second-grafico-linha-2">
              Lista de qtd. de ocorrências dos servidores
            </div>

            <div class="lista-second-grafico-linha-2">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Tagname</th>
                    <th>Qtd.Ocorrências</th>
                    <th>Jogo</th>
                  </tr>
                </thead>
                <tbody>

                </tbody>
              </table>
            </div>
          </div>


        </div>
      </div>
    </div>
  </main>
</body>

</html>

<script>

  function atualizarChamados() {
    fetch('/jira/chamados-abertos')
      .then(res => res.json())
      .then(chamados => {
        atualizarChamadosAbertos(chamados);
        atualizarChamadosSemAtribuicao(chamados);
      })
      .catch(err => console.error('Erro ao buscar chamados:', err));
  }

  function atualizarChamadosAbertos(chamados) {
    document.getElementById('kpi-chamados-abertos').textContent = chamados.length;
  }

  function atualizarChamadosSemAtribuicao(chamados) {
    const totalAbertos = chamados.length;
    const chamadosSemAtribuicao = chamados.filter(c => c.fields.assignee == null).length; // pega os chamados que são nulos

    document.getElementById('kpi-chamados-abertos-sem-atribuicao').textContent = chamadosSemAtribuicao;
    const porcentagem = ((chamadosSemAtribuicao / totalAbertos) * 100).toFixed(0); // coloco em porcentagem sobre o total
    document.getElementById('porcentagemKpiSemAtribuicao').textContent = porcentagem + "%";
  }


  function alertasPorServidor() {
    fetch('/server/getAlertsPerServer')
      .then(response => response.json())
      .then(data => {
        console.log("Alertas por servidor:", data);

        const tbody = document.querySelector(".lista-second-grafico-linha-2 table tbody");
        const qtd_ocorrencias = document.getElementById("sv_ocorrencias");
        const tag_name = document.getElementById("sv_tag_name");


        tbody.innerHTML = "";

        data.forEach(servidor => {

          qtd_ocorrencias.textContent = servidor.total_alertas;
          tag_name.textContent = servidor.tag_name;

          const row = document.createElement("tr");
          row.innerHTML = `
                <td>${servidor.id}</td>
                <td>${servidor.tag_name}</td>
                <td>${servidor.total_alertas}</td>
                <td>${servidor.game}</td>
            `;
          tbody.appendChild(row);
        });
      })
      .catch(error => {
        console.error("Erro ao buscar alertas por servidor:", error);
      });
  }

  function getResponsavelSemAtribuicao() {
    fetch('/jira/chamados-abertos').then(response => response.json()).then(chamado => {
      const tbody = document.querySelector(".lista-first-grafico-linha-2 table tbody");

      tbody.innerHTML = "";

      chamado.forEach(responsavel => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${responsavel.id}</td>
            <td>${responsavel.fields.reporter.displayName}</td>
            <td>${responsavel.fields.status.name}</td>
            <td>${responsavel.key}</td>
          `;
        tbody.appendChild(row);
      })
    })
  }

  function getChamadosTotais() {
    fetch('/jira/chamados-totais').then(response => response.json()).then(chamados => {
      const total = document.getElementById("kpi-chamados-totais");

      total.textContent = chamados.length;
    })
  }

  function getChamadosSemReponsavel() {
    fetch('/server/getChamadosSemResponsavel')
      .then(response => response.json())
      .then(data => {
        console.log("Chamados por servidor:", data);

        const tbody = document.querySelector(".lista-second-grafico-linha-1 table tbody");

        tbody.innerHTML = "";

        data.forEach(servidor => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${servidor.id}</td>
            <td>${servidor.tag_name}</td>
            <td>${servidor.idJira}</td>
            <td>${servidor.nivel}</td>
          `;
          tbody.appendChild(row);
        });
      })
      .catch(error => {
        console.error("Erro ao buscar alertas por servidor:", error);
      });
  }

  // const diasDoMes = Array.from({ length: 30 }, (_, i) => `${i + 1}`);

async function getRelatorioDeChamadosDoMesPassado() {
    const resposta = await fetch('server/getRelatorioDeChamadosDoMesPassado');
    const dados = await resposta.json()

    const categorias = dados.map(item => item.dia)
    const valores = dados.map(item => item.total_alertas)


  const options = {
    chart: {
      type: "line",
      height: 230,
      toolbar: { show: false },
      animations: {
        enabled: true,
      },
    },
    series: [
      {
        name: "Chamados",
        data: valores,
      },
    ],
    stroke: {
      width: 2, // grossura da linha diminuída
      colors: ["#4D1D95"], // cor personalizada da linha
    },
    xaxis: {
      categories: categorias,
      labels: {
        rotate: -45,
        style: {
          fontSize: "12px",
        },
      },
    },
    yaxis: {
      title: {
        text: "Número de Chamados",
      },
    },
    title: {
      text: "",
      align: "center",
    },
    responsive: [
      {
        breakpoint: 1350,
        options: {
          chart: {
            height: 300,
          },
          xaxis: {
            labels: {
              rotate: -30,
              style: {
                fontSize: "10px",
              },
            },
          },
        },
      },
      {
        breakpoint: 480,
        options: {
          chart: {
            height: 180,
          },
          xaxis: {
            labels: {
              rotate: -20,
              style: {
                fontSize: "9px",
              },
            },
          },
        },
      },
    ],
  };
  const chart = new ApexCharts(document.querySelector("#chart"), options);
  chart.render();
}


</script>