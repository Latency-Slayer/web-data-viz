<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latency Slayer - Dashboard Usuários</title>

    <script src="script/components/alertaChamado.js"></script>
    <script src="script/components/navBar.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style/dashJiraSlack.css">
</head>

<body>
    <main>
        <nav-bar></nav-bar>

        <div class="container-kpi">
            <div class="kpi-1">
                <h2>Chamados Pendentes</h2>
                <span id="kpi-chamados-pendentes">0</span>
            </div>
            <div class="kpi-2">
                <h2>Chamados em Análise</h2>
                <span id="kpi-chamados-em-analise">0</span>
            </div>
            <div class="kpi-3">
                <h2>Chamados do Dia</h2>
                <span id="kpi-chamados-abertos">0</span>
            </div>
            <div class="kpi-4">
                <h2>Tempo Médio de Resposta: 60 minutos</h2>
                <span>0</span>
            </div>
            <div class="kpi-5">
                <h2>Chamados Concluídos fora do Tempo</h2>
                <span>0</span>
            </div>
        </div>
        <!-- <div class="sorts">
            
            <div class="left">
                <div class="sortBtn">
                    <img src="img/filterIcon.png" alt="">
                    Filtrar
                </div>

                <div class="sortBtn">
                    <img src="img/sortIcon.png" alt="">
                    Ordenar
                </div>
            </div>

            <div class="right">
                <div class="sortBtn">
                    <img src="img/allServersIcon.png" alt="">
                    Ver todos os chamados
                </div>
            </div>
        </div> -->
        <div class="espaco" id="espaco">
            <div class="container1" id="chamados-container"></div>

            <div class="container2" id="chamados-outros"></div>
        </div>
    </main>

    <script>

let chamadosExistentes = [];

function getChamados() {
    fetch('/jira/chamados-abertos')
        .then(res => res.json())
        .then(data => {
            const containerPendentes = document.getElementById('chamados-pendentes');
            const containerOutros = document.getElementById('chamados-outros');

            // Limpa os containers antes de adicionar novos
            containerPendentes.innerHTML = '';
            containerOutros.innerHTML = '';

            const kpiElement = document.getElementById('kpi-chamados-abertos');
            kpiElement.textContent = data.length;

            const chamadosPendentes = data.filter(chamado => chamado.fields.status.name.toLowerCase() === "pendente");
            const kpiPendentes = document.getElementById('kpi-chamados-pendentes');
            kpiPendentes.textContent = chamadosPendentes.length;

            const chamadosEmAnalise = data.filter(chamado => chamado.fields.status.name.toLowerCase() === "em análise");
            const kpiEmAnalise = document.getElementById('kpi-chamados-em-analise');
            kpiEmAnalise.textContent = chamadosEmAnalise.length;

            if (data.length === 0) {
                containerPendentes.innerHTML = '<p>Nenhum chamado aberto encontrado.</p>';
                containerOutros.innerHTML = '<p>Nenhum chamado aberto encontrado.</p>';
                return;
            }

            // Elimina duplicados
            const novosChamados = data.filter(chamado => {
                return !chamadosExistentes.includes(chamado.key);
            });

            chamadosExistentes = chamadosExistentes.concat(novosChamados.map(chamado => chamado.key));

            novosChamados.sort((a, b) => {
                const statusOrder = {
                    "pendente": 1,
                    "em análise": 2,
                    "fazendo": 3
                };
                const statusA = a.fields.status.name.toLowerCase();
                const statusB = b.fields.status.name.toLowerCase();
                return (statusOrder[statusA] || 99) - (statusOrder[statusB] || 99);
            });

            novosChamados.forEach(chamado => {
                const card = document.createElement('div');
                card.className = 'card';

                card.innerHTML = `
                    <div class="linha1">
                        <span>${chamado.key} - ${chamado.fields.summary}</span>
                    </div>
                    <div class="linha2">    
                        <div class="coluna_esquerda">
                            <span><strong>ID: </strong>${chamado.id}</span>
                        </div>
                        <div class="coluna_direita">
                            <span><strong>Data de Criação:</strong> ${new Date(chamado.fields.created).toLocaleDateString('pt-BR')} ${new Date(chamado.fields.created).toLocaleTimeString('pt-BR')}</span>
                        </div>
                    </div>
                    <div class="linha3">    
                        <div class="coluna_esquerda">
                            <span><strong>Responsável:</strong> ${chamado.fields.assignee ? chamado.fields.assignee.displayName : 'Não atribuído'}</span>
                        </div>
                        <div class="coluna_direita">
                            <span><strong>Status:</strong> <span class="status">${chamado.fields.status.name}</span></span>
                        </div>
                    </div>
                    <div class="linha4">
                        <span><strong>Descrição:</strong> ${chamado.fields.description?.content?.[0]?.content?.[0]?.text || 'Sem descrição'}</span>
                    </div>`;

                const statusSpan = card.querySelector(".status");
                const status = chamado.fields.status.name.toLowerCase();

                if (status === "pendente") {
                    statusSpan.style.color = "red";
                } else if (status === "em análise") {
                    statusSpan.style.color = "orange";
                } else if (status === "fazendo") {
                    statusSpan.style.color = "gold";
                }

                statusSpan.style.fontWeight = "bold";

                // Adiciona no container certo
                if (status === "pendente") {
                    containerPendentes.appendChild(card);
                } else {
                    containerOutros.appendChild(card);
                }
            });
        })
        .catch(err => {
            console.error('Erro ao buscar chamados:', err);
            document.getElementById('chamados-pendentes').innerHTML = '<p>Erro ao buscar chamados.</p>';
            document.getElementById('chamados-outros').innerHTML = '<p>Erro ao buscar chamados.</p>';
        });
}

getChamados();
setInterval(getChamados, 5000);



    </script>
    </div>

</body>

</html>